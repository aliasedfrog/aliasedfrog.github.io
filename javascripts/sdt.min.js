$(document)
        .ready(
                function() {
	                function buildMapInfo(data) {
		                if (data.serverMapList != null) {
			                var mapList = "";
			                for (i = 0; i < data.serverMapList.length; i++) {
				                if (i != 0) {
					                mapList += '", "' + data.serverMapList[i].name;
				                } else {
					                mapList += '"' + data.serverMapList[i].name;
				                }
				                if (i == data.serverMapList.length - 1
				                        || data.serverMapList.length == 1) {
					                mapList += '"';
				                }
			                }
			                return mapList;
		                }
	                }
	                function buildMapInfoHeader(data) {
		                if (data.serverMapList != null) {
			                var mapList = "";
			                for (i = 0; i < data.serverMapList.length; i++) {
				                if (i != 0) {
					                mapList += '</b>", "<b>' + data.serverMapList[i].name;
				                } else {
					                mapList += '"<b>' + data.serverMapList[i].name;
				                }
				                if (i == data.serverMapList.length - 1
				                        || data.serverMapList.length == 1) {
					                mapList += '</b>"';
				                }
			                }
			                return mapList;
		                }
	                }

	                var tableHeight = 60;
	                var ajaxData;
	                var ajax1;
	                var updateServerData = function(oTable) {
		                ajax1 = $.ajax({
		                	crossDomain : true,
		                    url : 'http://www.benrcoulston.us/reflex/json?servers=online',
		                    data : {
			                    format : 'json'
		                    },
		                    dataType : 'json',
		                    success : function(data, status, jqXHR) {
			                    populateMenu(data);
			                    $('div.mapInfo').html(
			                            '<h6 class=\"mapHeader\">Maps seen on server:<br/></h6>');
			                    ajaxData = data;
			                    oTable.clear();
			                    oTable.rows.add(data.data);
			                    oTable.columns.adjust().draw();
			                    $('#sdt').closest('table').height(calcDataTableHeight(tableHeight))
			                            .width('1032px');
			                    $('#sidtheader').height(
			                            $('div.mapInfo').height() - $('#sidt_info').height());

		                    },
		                    failure: function(data, status, jqXHR){
		                    	alert(status);
		                    }
		                    type : 'GET',
		                });
	                }

	                var sdtId = window.setInterval(function() {
		                var oTable = $('#sdt').DataTable();
		                updateServerData(oTable);
	                }, 120000);

	                var sdt = $('#sdt')
	                        .DataTable(
	                                {
	                                    "search" : {
		                                    "caseInsensitive" : true,
	                                    },
	                                    "language" : {
	                                        "processing" : "Loading server information...",
	                                        "infoEmpty" : "No servers found.",
	                                        "zeroRecords" : "No servers matched your search.",
	                                        "infoEmpty" : "Showing 0 servers",
	                                        "info" : "_TOTAL_ servers"
	                                    },
	                                    "columns" : [
	                                            {
	                                                "title" : "Pop",
	                                                "defaultContent" : "",
	                                                "data" : "popularity",
	                                                "width" : "1%",
	                                                "orderable" : false,
	                                            },
	                                            {
	                                                "title" : "T",
	                                                "defaultContent" : "",
	                                                "data" : "serverType",
	                                                "width" : "1%",
	                                                "orderable" : false,
	                                                "render" : function(data, type, full, meta) {
		                                                return data.substring(0, 1).toUpperCase();
	                                                }
	                                            },
	                                            {
	                                                "title" : "Name",
	                                                "defaultContent" : "",
	                                                "data" : "serverName"
	                                            },
	                                            {
	                                                "title" : "Loc",
	                                                "defaultContent" : "",
	                                                "data" : "locale",
	                                                "width" : "1%",
	                                                "render" : function(data, type, full, meta) {
		                                                var returnString = '<div class="centered">';
		                                                if (data.countryCode != ""
		                                                        && data.countryCode != null) {
			                                                var conFlag = data.countryCode
			                                                        .toLowerCase()
			                                                        + ".gif";
			                                                returnString += '<img src="//aliasedfrog.github.io/images/'
			                                                        + conFlag + '"/><br/>';
		                                                } else {
			                                                returnString += '[?]';
		                                                }
		                                                if (data.regionCode != ""
		                                                        && data.regionCode != null) {
			                                                returnString += '<span style=\"font-size: x-small\">['
			                                                        + data.regionCode + ']</span>';
		                                                }
		                                                return returnString + '</div>';
	                                                }
	                                            },
	                                            {
	                                                "title" : "Ip:Port",
	                                                "defaultContent" : "",
	                                                "orderable" : false,
	                                                "data" : "ipAddress",
	                                                "width" : "1%",
	                                                "render" : function(data, type, row, meta) {
		                                                return '<a class="btn btn-mini btn-success text-center" style="width: 120px;" href=\"steam:\/\/connect\/'
		                                                        + data
		                                                        + ':'
		                                                        + row.serverPort
		                                                        + '\">'
		                                                        + data
		                                                        + ':'
		                                                        + row.serverPort + '</a>'
	                                                }
	                                            }, {
	                                                "title" : "Map",
	                                                "defaultContent" : "",
	                                                "data" : "map.name",
	                                                "width" : "1%",
	                                            }, {
	                                                "title" : "Plyrs",
	                                                "searchable" : false,
	                                                "defaultContent" : "",
	                                                "data" : "playerCount",
	                                                "width" : "1%",
	                                                "render" : function(data, type, row, meta) {
		                                                return data + '/' + row.maxPlayers;
	                                                }

	                                            }, {
	                                                "title" : "UpTime",
	                                                "defaultContent" : "",
	                                                "searchable" : false,
	                                                "data" : "serverUpTime",
	                                                "width" : "1%",
	                                                "orderable" : false,
	                                            }, {
	                                                "title" : "Vers",
	                                                "defaultContent" : "",
	                                                "data" : "gameVersion",
	                                                "width" : "1%",
	                                            }, {
	                                                "title" : "Last",
	                                                "defaultContent" : "",
	                                                "searchable" : false,
	                                                "data" : "lastResponse",
	                                                "width" : "1%",
	                                            }, {
	                                                "title" : "Maps",
	                                                "defaultContent" : "",
	                                                "orderable" : false,
	                                                "data" : "serverMapList",
	                                                "width" : "1%",
	                                                "visible" : false,
	                                                "render" : function(data, type, row, meta) {
		                                                var ret = "";
		                                                for (i = 0; i < data.length; i++) {
			                                                ret += data[i].name + ' ';
		                                                }
		                                                return ret;
	                                                }
	                                            }, ],
	                                    "scrollY" : calcDataTableHeight(tableHeight),
	                                    "scrollCollapse" : true,
	                                    "order" : [ [ 0, "desc" ], [ 6, "desc" ], [ 8, "desc" ],
	                                            [ 9, "desc" ] ],
	                                    "paging" : false,
	                                    "deferRender" : true,
	                                    "dom" : '<"row"<"mapInfo span8" ><"span3 offset1 pull-right"f>>lrt',
	                                    "autoWidth" : false,
	                                    "processing" : false,
	                                    "createdRow" : function(row, data, dataIndex) {
		                                    setPopularityCSS(data, row);
		                                    setCellTitles(data, row);
		                                    if (data.serverMapList != null) {
			                                    row.title = 'Known Maps=(' + buildMapInfo(data)
			                                            + ')';
		                                    }
	                                    },
	                                    "columnDefs" : [
	                                            {
	                                                "render" : function(data, type, row, meta) {
		                                                return '<span style=\"font-size: xx-small;line-height:6px\">'
		                                                        + data + '</span>';
	                                                },
	                                                "targets" : [ 9, 10 ]
	                                            }, {
	                                                "className" : "tdTextCenter centerVert",
	                                                "targets" : [ 0, 1 ]
	                                            }, {
	                                                "className" : "centerVert",
	                                                "targets" : "_all"
	                                            } ],
	                                });
	                updateServerData(sdt);

	                var sidt = $('#sidt').DataTable({
	                    "language" : {
	                        "processing" : "Loading player information...",
	                        "infoEmpty" : "No players found.",
	                        "zeroRecords" : "No server selected.",
	                        "infoEmpty" : "No server selected.",
	                        "info" : "_TOTAL_ players"
	                    },
	                    "columns" : [ {
	                        "title" : "Name",
	                        "data" : "name",
	                        "render" : function(data, type, row, meta) {
		                        if (data.length > 10) {
			                        return data.substring(0, 9);
		                        }
		                        return data;
	                        }

	                    }, {
	                        "title" : "Score",
	                        "data" : "score",
	                        "width" : "1%"
	                    }, {
	                        "title" : "Time",
	                        "data" : "connectTime",
	                        "width" : "1%"
	                    }, ],
	                    "processing" : false,
	                    "autoWidth" : false,
	                    "order" : [ [ 1, "asc" ], [ 0, "asc" ] ],
	                    "scrollY" : calcDataTableHeight(tableHeight),
	                    "scrollCollapse" : false,
	                    "paging" : false,
	                    "deferRender" : true,
	                    "dom" : 'irt',
	                    "height" : calcDataTableHeight(tableHeight),
	                    "width" : '265px',
	                });

	                $('#sidt').closest('table').height(calcDataTableHeight(tableHeight)).width(
	                        '255px');

	                var selected;
	                // Add event listener for opening and closing details
	                $('#sdt tbody').on(
	                        'click',
	                        'tr',
	                        function() {
		                        var sTable = $('#sdt').DataTable();
		                        var tr = $(this).closest('tr');
		                        var row = sTable.row(tr);
		                        var data = row.data();
		                        $('div.mapInfo').html(
		                                '<h6 class=\"mapHeader\">Maps seen on server: '
		                                        + buildMapInfoHeader(data) + '</h6>');
		                        sTable.rows('.info').nodes().to$().removeClass('info');
		                        if (data.serverName == selected) {
			                        selected = null;
			                        sidt.clear();
		                        } else {
			                        sidt.clear();
			                        sidt.rows.add(data.playerList);
			                        selected = data.serverName;
			                        $(this).addClass('info');
		                        }
		                        sidt.columns.adjust().draw();
		                        $('#sidtheader').height(
		                                $('div.mapInfo').height() - $('#sidt_info').height());
		                        $('#sidt').closest('table')
		                                .height(calcDataTableHeight(tableHeight)).width('255px');
	                        });

	                function setCellTitles(data, row) {
		                var titleType = "Type: " + data.serverType.substring(0, 1).toUpperCase()
		                        + data.serverType.substring(1, data.serverType.length);
		                $(row).find('td:nth(1)').attr("title", titleType);
		                var titleLoc = "Country: " + data.locale.countryName + ' Region: '
		                        + data.locale.regionName;
		                $(row).find('td:nth(3)').attr("title", titleLoc);
		                var titleUpTime = "Uptime based on server response to query, only provides example of how long the server has been active";
		                $(row).find('td:nth(7)').attr("title", titleUpTime);
		                var titleLast = "Last response date & time was: " + data.lastResponse;
		                $(row).find('td:nth(9)').attr("title", titleLast);
	                }

	                function setPopularityCSS(data, row) {
		                var title = "Server popularity scale 0/100, gains 1 each query with more than 2 players, loses 0.5 each query less than 2 players"
		                if (data.popularity > 75) {
			                $(row).find('td:first').attr("title", title).css("background-image",
			                        "linear-gradient(to right, green, blue,rgb(255, 255, 255))");
		                } else if (data.popularity > 50) {
			                $(row).find('td:first').attr("title", title).css("background-image",
			                        "linear-gradient(to right, yellow ,green,rgb(255, 255, 255))");
		                } else if (data.popularity > 25) {
			                $(row).find('td:first').attr("title", title).css("background-image",
			                        "linear-gradient(to right, red ,yellow,rgb(255, 255, 255))");
		                } else {
			                $(row).find('td:first').attr("title", title).css("background-image",
			                        "linear-gradient(to right, red ,red,rgb(255, 255, 255))");
		                }

	                }
                });
